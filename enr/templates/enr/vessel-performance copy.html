{% extends 'base.html' %}

{% block title %}Vessel Parameter{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto p-6">
    <h2 class="text-2xl font-bold mb-4 text-center">Vessel Parameter</h2>

    <!-- Filters -->
    <div class="flex flex-wrap gap-4 justify-center mb-6">
        <select id="vessel-select" class="px-4 py-2 border rounded-md">
            <option value="">Loading vessels...</option>
        </select>

        <select id="movement-select" class="px-4 py-2 border rounded-md">
            <option value="">Loading movements...</option>
        </select>

        <select id="displacement-select" class="px-4 py-2 border rounded-md">
            <option value="">Loading displacements...</option>
        </select>

        <input type="date" id="start-date" class="px-4 py-2 border rounded-md">
        <input type="date" id="end-date" class="px-4 py-2 border rounded-md">

        <button onclick="openFilterPane()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
            Filter Parameters
        </button>

        <button onclick="applyFilters()" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
            Apply Filters
        </button>

        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">
            Logout
        </button>
    </div>

    <!-- Parameter Filter Pane -->
    <div id="filter-pane" class="fixed top-0 right-0 w-64 h-full bg-white shadow-lg p-4 transform translate-x-full transition-transform duration-300 ease-in-out">
        <h3 class="text-lg font-semibold mb-2">Select Parameters</h3>
        <div id="parameter-checkboxes" class="space-y-2 overflow-y-auto max-h-[70vh]"></div>
        <button onclick="closeFilterPane()" class="bg-gray-400 text-white px-4 py-2 rounded-md mt-4 w-full">
            Close
        </button>
    </div>

    <!-- Scatter Chart -->
    <div class="bg-white shadow-md rounded-lg p-6">
        <canvas id="scatterChart"></canvas>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto mt-4">
        <table class="min-w-full border border-gray-400 shadow-md rounded-lg text-sm">
            <thead class="bg-gray-200 text-gray-700">
                <tr id="table-head" class="border border-gray-400">
                    <!-- Dynamic headers will be added here -->
                </tr>
            </thead>
            <tbody id="table-body" class="text-center text-gray-900">
                <!-- Dynamic rows will be added here -->
            </tbody>
        </table>
    </div>

    <div class="flex justify-center space-x-4 mt-4">
        <button id="prev-page" class="px-3 py-1 bg-gray-300 rounded disabled:opacity-50">Previous</button>
        <span id="pagination-info" class="px-2">Page 1</span>
        <button id="next-page" class="px-3 py-1 bg-gray-300 rounded disabled:opacity-50">Next</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global Variables
    let scatterChart = null;
    let currentPage = 1;
    let pageSize = 10;
    let totalRows = 0;
    const API_BASE_URL = window.location.origin;

    // On DOMContentLoaded, check auth and load initial data
    document.addEventListener("DOMContentLoaded", () => {
        checkAuth();
        fetchVesselList();
        fetchParameterList();
        fetchFilterOptions();
    });

    /* =======================
       Authentication & Token
       ======================= */
    function checkAuth() {
        const token = localStorage.getItem("access_token");
        if (!token) {
            redirectToLogin();
            return;
        }
        try {
            const payload = JSON.parse(atob(token.split(".")[1]));
            const currentTime = Math.floor(Date.now() / 1000);
            if (payload.exp < currentTime) {
                console.warn("Access token expired. Trying to refresh...");
                refreshToken().then(success => {
                    if (!success) {
                        alert("Session expired. Please log in again.");
                        redirectToLogin();
                    }
                });
            }
        } catch (error) {
            console.error("Invalid token:", error);
            redirectToLogin();
        }
    }

    function redirectToLogin() {
        alert("You need to log in first.");
        window.location.href = "/user/login-page/";
    }

    async function refreshToken() {
        const refreshToken = localStorage.getItem("refresh_token");
        if (!refreshToken) {
            console.warn("No refresh token available.");
            return false;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/api/token/refresh/`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ refresh: refreshToken })
            });
            if (!response.ok) {
                console.warn("Refresh token is invalid or expired.");
                return false;
            }
            const data = await response.json();
            if (data.access) {
                localStorage.setItem("access_token", data.access);
                return true;
            }
            return false;
        } catch (error) {
            console.error("Error refreshing token:", error);
            return false;
        }
    }

    // Unified fetch function (handles token and refresh)
    async function fetchWithAuth(url, options = {}) {
        const token = localStorage.getItem("access_token");
        if (!token) {
            redirectToLogin();
            return;
        }
        options.headers = {
            ...options.headers,
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
        };
        let response = await fetch(url, options);
        if (response.status === 401) {
            console.warn("Access token expired. Attempting to refresh...");
            const refreshed = await refreshToken();
            if (refreshed) {
                options.headers["Authorization"] = `Bearer ${localStorage.getItem("access_token")}`;
                response = await fetch(url, options);
            } else {
                console.error("Token refresh failed. Logging out.");
                localStorage.removeItem("access_token");
                localStorage.removeItem("refresh_token");
                redirectToLogin();
                return;
            }
        }
        return response;
    }

    function logout() {
        localStorage.removeItem("access_token");
        localStorage.removeItem("refresh_token");
        window.location.href = "/user/login-page/";
    }

    /* ============================
       Utility Functions for Filters
       ============================ */
    function getFilterParams() {
        return {
            vessel: document.getElementById("vessel-select").value,
            movement: document.getElementById("movement-select").value,
            displacement: document.getElementById("displacement-select").value,
            start_date: document.getElementById("start-date").value,
            end_date: document.getElementById("end-date").value,
            parameters: getSelectedParameters()
        };
    }

    // Builds a URL from an endpoint and extra parameters (e.g. pagination, full_data flag)
    function buildUrl(endpoint, extraParams = {}) {
        const url = new URL(`${API_BASE_URL}${endpoint}`);
        const filters = getFilterParams();
        const params = new URLSearchParams();
        if (filters.vessel) params.append("vessel", filters.vessel);
        if (filters.movement) params.append("movement", filters.movement);
        if (filters.displacement) params.append("displacement", filters.displacement);
        if (filters.start_date) params.append("start_date", filters.start_date);
        if (filters.end_date) params.append("end_date", filters.end_date);
        filters.parameters.forEach(param => params.append("parameters", param));
        Object.keys(extraParams).forEach(key => {
            params.append(key, extraParams[key]);
        });
        url.search = params.toString();
        return url;
    }

    /* ============================
       Data Fetching Functions
       ============================ */
    async function fetchVesselList() {
        try {
            const response = await fetchWithAuth(`${API_BASE_URL}/api/vessels/`);
            if (!response.ok) throw new Error("Failed to fetch vessels");
            const data = await response.json();
            const vessels = Array.isArray(data) ? data : data.results;
            populateVesselDropdown(vessels);
        } catch (error) {
            console.error("Error fetching vessels:", error);
        }
    }

    function populateVesselDropdown(vessels) {
        const vesselSelect = document.getElementById("vessel-select");
        vesselSelect.innerHTML = `<option value="">Select Vessel</option>`;
        if (Array.isArray(vessels)) {
            vessels.forEach(vessel => {
                const option = document.createElement("option");
                option.value = vessel.id;
                option.textContent = vessel.vesselname;
                vesselSelect.appendChild(option);
            });
        } else {
            console.error("Expected an array of vessels, but got:", vessels);
        }
    }

    async function fetchParameterList() {
        try {
            const response = await fetchWithAuth(`${API_BASE_URL}/api/parameters/`);
            if (!response.ok) throw new Error("Failed to fetch parameters");
            const data = await response.json();
            const parameters = Array.isArray(data) ? data : data.results;
            populateParameterFilters(parameters);
        } catch (error) {
            console.error("Error fetching parameters:", error);
        }
    }

    function populateParameterFilters(parameters) {
        const container = document.getElementById("parameter-checkboxes");
        container.innerHTML = "";
        parameters.forEach(param => {
            const div = document.createElement("div");
            div.innerHTML = `
                <label class="flex items-center space-x-2">
                    <input type="checkbox" value="${param.id}" class="form-checkbox">
                    <span>${param.description}</span>
                </label>
            `;
            container.appendChild(div);
        });
    }

    async function fetchFilterOptions() {
        try {
            const response = await fetchWithAuth(`${API_BASE_URL}/api/filters/`);
            if (!response.ok) throw new Error("Failed to fetch filter options");
            const data = await response.json();
            populateDropdown("movement-select", data.movements, "Select Movement");
            populateDropdown("displacement-select", data.displacements, "Select Displacement");
        } catch (error) {
            console.error("Error fetching filter options:", error);
        }
    }

    function populateDropdown(elementId, options, defaultText) {
        const select = document.getElementById(elementId);
        select.innerHTML = `<option value="">${defaultText}</option>`;
        if (Array.isArray(options)) {
            options.forEach(value => {
                const option = document.createElement("option");
                option.value = value;
                option.textContent = value;
                select.appendChild(option);
            });
        } else {
            console.error(`Expected an array for ${elementId}, but got:`, options);
        }
    }

    /* ============================
       UI Interactions & Filter Pane
       ============================ */
    function openFilterPane() {
        document.getElementById("filter-pane").classList.remove("translate-x-full");
    }

    function closeFilterPane() {
        document.getElementById("filter-pane").classList.add("translate-x-full");
    }

    function getSelectedParameters() {
        return Array.from(document.querySelectorAll("#parameter-checkboxes input:checked"))
                    .map(checkbox => checkbox.value);
    }

    // Called when the user clicks "Apply Filters"
    function applyFilters() {
        currentPage = 1; // Reset pagination
        // Build URL for table data (paginated)
        const tableUrl = buildUrl("/api/performance/multiple/");
        console.log("Constructed Table URL:", tableUrl.toString());
        // Fetch chart data (full data) and table data (paginated)
        fetchChartData(buildUrl("/api/performance/multiple/", { full_data: "true" }));
        fetchTableData(tableUrl);
    }

    // Fetch chart data (full data for plotting)
    async function fetchChartData(url) {
        try {
            console.log("Constructed URL for Chart Data:", url.toString());
            const response = await fetchWithAuth(url);
            if (!response.ok) {
                if (response.status === 401) {
                    alert("Session expired. Please log in again.");
                    logout();
                } else {
                    throw new Error("Failed to fetch chart data");
                }
            }
            const chartData = await response.json();
            console.log("API Response (Chart Data):", chartData.results);
            plotScatterChart(chartData.results);
        } catch (error) {
            console.error("Error fetching chart data:", error);
        }
    }

    // Fetch table data (paginated)
    async function fetchTableData(url) {
        try {
            console.log("Constructed URL for Table Data:", url.toString());
            const response = await fetchWithAuth(url);
            if (!response.ok) {
                if (response.status === 401) {
                    alert("Session expired. Please log in again.");
                    logout();
                } else {
                    throw new Error("Failed to fetch table data");
                }
            }
            const tableData = await response.json();
            console.log("API Response (Table Data):", tableData);
            displayTable(tableData.results);
            totalRows = tableData.count || 0;
            const maxPages = Math.max(1, Math.ceil(totalRows / pageSize));
            updatePaginationControls(tableData.next, tableData.previous);
            document.getElementById("pagination-info").textContent = `Page ${currentPage} of ${maxPages}`;
        } catch (error) {
            console.error("Error fetching table data:", error);
        }
    }

    // Display table data dynamically
    function displayTable(data) {
        const tableHead = document.getElementById("table-head");
        const tableBody = document.getElementById("table-body");
        tableHead.innerHTML = "";
        tableBody.innerHTML = "";
        if (data.length === 0) {
            tableBody.innerHTML = "<tr><td colspan='5' class='px-4 py-2 border text-center'>No data available</td></tr>";
            return;
        }
        // Build a map from parameter ID to its description using checkbox labels
        let parameterMap = {};
        document.querySelectorAll("#parameter-checkboxes input[type='checkbox']").forEach(checkbox => {
            parameterMap[checkbox.value] = checkbox.nextElementSibling.textContent;
        });
        // Dynamically extract parameter keys from the first data row
        const parameterKeys = Object.keys(data[0]).filter(key => key.startsWith("parameter_"));
        // Build table header row
        let headerRow = `
            <tr class="border-b">
                <th class="px-4 py-2 border">Date</th>
                <th class="px-4 py-2 border">Movement</th>
                <th class="px-4 py-2 border">Displacement</th>
        `;
        parameterKeys.forEach(key => {
            const paramId = key.replace("parameter_", "");
            const paramDesc = parameterMap[paramId] || key;
            headerRow += `<th class="px-4 py-2 border">${paramDesc}</th>`;
        });
        headerRow += "</tr>";
        tableHead.innerHTML = headerRow;
        // Populate table rows
        data.forEach(item => {
            let row = `
                <tr class="border-b">
                    <td class="px-2 py-1 border w-32 whitespace-nowrap">${item.date}</td>
                    <td class="px-4 py-2 border">${formatNumber(item.movement)}</td>
                    <td class="px-4 py-2 border">${formatNumber(item.displacement)}</td>
            `;
            parameterKeys.forEach(key => {
                row += `<td class="px-4 py-2 border">${formatNumber(item[key])}</td>`;
            });
            row += "</tr>";
            tableBody.innerHTML += row;
        });
    }

    function formatNumber(value) {
        return (typeof value === "number" && !isNaN(value)) ? value.toFixed(2) : value;
    }

    // Update pagination controls (disable/enable next/prev buttons)
    function updatePaginationControls(next, previous) {
        document.getElementById("prev-page").disabled = !previous;
        document.getElementById("next-page").disabled = !next;
    }

    /* ============================
       Pagination Functions
       ============================ */
    // Shared function to change page (increment can be 1 or -1)
    function changePage(increment) {
        const totalPages = Math.ceil(totalRows / pageSize);
        const newPage = currentPage + increment;
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            const url = buildUrl("/api/performance/multiple/", { page: currentPage });
            console.log(`Paginated URL with Filters (Page ${currentPage}):`, url.toString());
            fetchTableData(url);
        }
    }
    function nextPage() { changePage(1); }
    function prevPage() { changePage(-1); }
    document.getElementById("prev-page").addEventListener("click", prevPage);
    document.getElementById("next-page").addEventListener("click", nextPage);

    /* ============================
       Chart Plotting using Chart.js
       ============================ */
    function plotScatterChart(data) {
        const ctx = document.getElementById("scatterChart").getContext("2d");
        const selectedParameters = getSelectedParameters();
        let parameterMap = {};
        document.querySelectorAll("#parameter-checkboxes input[type='checkbox']").forEach(checkbox => {
            parameterMap[checkbox.value] = checkbox.nextElementSibling.textContent;
        });
        const datasets = selectedParameters.map(paramId => ({
            label: parameterMap[paramId] || `Parameter ${paramId}`,
            data: data.map(item => ({
                x: new Date(item.date),
                y: item[`parameter_${paramId}`] || 0
            })),
            borderColor: getRandomColor(),
            backgroundColor: "transparent",
            pointBackgroundColor: getRandomColor()
        }));
        if (scatterChart) scatterChart.destroy();
        scatterChart = new Chart(ctx, {
            type: "scatter",
            data: { datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { type: "time", time: { unit: "day" } },
                    y: { beginAtZero: true }
                }
            }
        });
    }

    function getRandomColor() {
        return `hsl(${Math.random() * 360}, 100%, 50%)`;
    }
</script>
{% endblock %}
